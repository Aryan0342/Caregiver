rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Pictogram sets collection
    match /pictogram_sets/{setId} {
      // Allow read if user is authenticated and owns the set
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
      
      // Allow create if user is authenticated and sets their own userId
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      
      // Allow update if user is authenticated and owns the set
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId &&
                       request.auth.uid == request.resource.data.userId;
      
      // Allow delete if user is authenticated and owns the set
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // Caregivers collection - users can only access their own profile
    match /caregivers/{caregiverId} {
      // Allow read if user is authenticated and accessing their own profile
      allow get: if request.auth != null && 
                    request.auth.uid == caregiverId;
      
      // Allow list/query operations:
      // - Authenticated users can query (for their own profile access)
      // - Unauthenticated users can query by email for forgot password flow
      //   (We check that the document has an email field, indicating it's a valid profile)
      //   Note: resource.data.email check ensures only profiles with email can be queried
      allow list: if request.auth != null || 
                     (request.auth == null && resource.data.email != null);
      
      // Allow create if user is authenticated and creating their own profile
      allow create: if request.auth != null && 
                       request.auth.uid == caregiverId;
      
      // Allow update if user is authenticated and updating their own profile
      allow update: if request.auth != null && 
                       request.auth.uid == caregiverId;
      
      // Allow delete if user is authenticated and deleting their own profile
      allow delete: if request.auth != null && 
                       request.auth.uid == caregiverId;
      
      // Settings subcollection - for PIN and other settings
      match /settings/{settingsId} {
        // Allow read if user is authenticated and accessing their own settings
        allow read: if request.auth != null && 
                       request.auth.uid == caregiverId;
        
        // Allow create if user is authenticated and creating their own settings
        allow create: if request.auth != null && 
                         request.auth.uid == caregiverId;
        
        // Allow update if user is authenticated and updating their own settings
        allow update: if request.auth != null && 
                         request.auth.uid == caregiverId;
        
        // Allow delete if user is authenticated and deleting their own settings
        allow delete: if request.auth != null && 
                         request.auth.uid == caregiverId;
      }
    }
    
    // Categories collection - app users can read, admins can write
    match /categories/{categoryId} {
      // Allow read for authenticated users (app users can view categories)
      allow read: if request.auth != null;
      
      // Allow write only for admin users
      allow create, update, delete: if request.auth != null && 
                                      exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                                      get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Custom pictograms collection - admin only for full CRUD, users can update usage stats
    match /custom_pictograms/{pictogramId} {
      // Allow read for authenticated users (app users can view custom pictograms)
      allow read: if request.auth != null;
      
      // Allow authenticated users to update only usageCount and lastUsedAt fields
      // This enables usage tracking when users add pictograms to sets
      // Check that only usageCount and/or lastUsedAt are being changed
      allow update: if request.auth != null &&
                     // Get the set of changed keys
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['usageCount', 'lastUsedAt']);
      
      // Allow create and delete only for admin users
      allow create, delete: if request.auth != null && 
                              exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                              get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
      
      // Allow admins to do full updates (for managing pictogram data like keyword, category, etc.)
      // This rule comes after the limited update rule, so admins can update any fields
      allow update: if request.auth != null && 
                     exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Admin users collection - admin management
    match /admin_users/{adminId} {
      // Only admins can read/write admin users
      allow read, write: if request.auth != null && 
                          exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                          get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Statistics collection - admin only
    match /statistics/{document=**} {
      // Allow read for authenticated users (for app statistics)
      allow read: if request.auth != null;
      
      // Allow write only for admin users
      allow write: if request.auth != null && 
                    exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                    get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Picto requests collection - users can create, admins can read/update
    match /picto_requests/{requestId} {
      // Allow authenticated users to create requests
      allow create: if request.auth != null &&
                     request.resource.data.requestedBy == request.auth.uid;
      
      // Allow users to read their own requests
      allow read: if request.auth != null &&
                   (resource.data.requestedBy == request.auth.uid ||
                    exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                    get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true);
      
      // Allow admins to update request status
      allow update: if request.auth != null &&
                     exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
      
      // Allow admins to delete requests
      allow delete: if request.auth != null &&
                     exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
